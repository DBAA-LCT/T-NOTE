# 页面级同步使用指南

## 功能介绍

页面级同步允许你将笔记的每个页面独立同步到 OneDrive，而不是整个笔记。这样可以：

- 减少同步冲突
- 更精确地控制哪些内容需要同步
- 支持在不同设备上编辑不同页面
- 查看每个页面的同步状态

## 快速开始

### 1. 连接 OneDrive

1. 打开"OneDrive 同步"面板
2. 点击"连接 OneDrive"按钮
3. 在浏览器中登录你的 Microsoft 账号
4. 授权应用访问 OneDrive

### 2. 启用笔记同步

1. 打开或新建一个笔记
2. 在"OneDrive 同步"面板中选择"启用同步"
3. 选择 OneDrive 中用于存储此笔记的文件夹
4. 笔记同步已启用！

### 3. 提交页面

#### 手动提交（默认）

1. 编辑页面内容
2. 页面标题旁会显示"未提交"标签
3. 点击"提交到云端"按钮
4. 等待上传完成，显示"已同步"

#### 自动提交（可选）

1. 在"OneDrive 同步"面板中启用"自动提交"
2. 编辑页面内容
3. 10秒后自动上传到云端
4. 显示"自动同步"标签

### 4. 查看云端页面

1. 打开"云端页面"面板
2. 查看当前笔记的所有云端页面
3. 页面状态说明：
   - ✓ **已同步**：本地和云端内容一致
   - ⚠ **云端较新**：云端版本比本地新
   - ⏱ **本地较新**：本地有未提交的修改
   - ⊗ **未同步**：页面不存在于云端

### 5. 使用云端版本

如果云端版本较新：

1. 在"云端页面"面板中点击该页面
2. 查看页面信息
3. 点击"使用云端版本"按钮
4. 确认后，云端内容会覆盖本地内容

## 同步状态说明

### 页面状态标签

- **已同步** (绿色)：页面已成功上传到云端
- **未提交** (黄色)：页面有本地修改，尚未上传
- **提交中** (蓝色)：正在上传到云端
- **提交失败** (红色)：上传失败，请检查网络
- **云端较新** (橙色)：云端版本比本地新，建议查看

### 自动同步标签

启用自动提交后，显示"自动同步"标签，表示编辑后会自动上传。

## 常见问题

### Q: 如何知道页面是否已同步？

A: 查看页面标题旁的状态标签。绿色"已同步"表示已成功上传。

### Q: 自动提交会立即上传吗？

A: 不会。为了避免频繁上传，自动提交会在编辑停止后10秒才上传。

### Q: 如果网络断开，编辑的内容会丢失吗？

A: 不会。内容会先保存到本地，恢复网络后可以手动提交。

### Q: 多个设备同时编辑同一页面会怎样？

A: 后提交的会覆盖先提交的。建议一次只在一个设备上编辑。

### Q: 云端较新时，本地修改会丢失吗？

A: 使用云端版本前，系统会自动创建本地备份，可以在需要时恢复。

### Q: 可以只同步部分页面吗？

A: 目前启用同步后，所有页面都可以提交。未来版本会支持选择性同步。

### Q: OneDrive 中的文件结构是怎样的？

A: 每个笔记在 OneDrive 中是一个文件夹，每个页面是一个 JSON 文件。
例如：`/Notes/我的笔记/页面1.json`

## 最佳实践

### 1. 定期提交

即使启用了自动提交，也建议在重要修改后手动提交，确保内容已上传。

### 2. 检查同步状态

在切换设备前，检查所有页面都显示"已同步"状态。

### 3. 处理冲突

如果看到"云端较新"标签：
1. 先查看云端内容
2. 如果需要保留本地修改，先备份
3. 再决定是使用云端版本还是强制提交本地版本

### 4. 网络环境

- 建议在 WiFi 环境下同步
- 可以在设置中启用"仅 WiFi 下同步"

### 5. 存储空间

定期检查 OneDrive 存储空间，避免因空间不足导致同步失败。

## 故障排除

### 提交失败

1. 检查网络连接
2. 检查 OneDrive 存储空间
3. 重新连接 OneDrive 账号
4. 查看错误信息

### 云端页面不显示

1. 刷新云端页面列表
2. 检查笔记是否已启用同步
3. 检查 OneDrive 文件夹权限

### 自动提交不工作

1. 检查是否启用了"自动提交"
2. 确保笔记已启用同步
3. 等待10秒后检查状态

## 技术说明

### 文件格式

每个页面在 OneDrive 中存储为 JSON 文件，包含：
- 页面 ID
- 标题
- 内容（HTML 格式）
- 标签
- 书签
- 创建和更新时间

### 同步机制

- 使用内容哈希快速判断是否需要上传
- 基于时间戳判断版本新旧
- 上传前验证文件完整性
- 下载后验证文件格式

### 安全性

- 所有通信使用 HTTPS 加密
- 使用 OAuth 2.0 认证
- 不存储密码，只存储访问令牌
- 令牌自动刷新，无需重新登录

## 反馈和支持

如果遇到问题或有建议，请：
1. 查看日志文件：`userData/onedrive-sync.log`
2. 提交问题报告
3. 联系技术支持

---

祝你使用愉快！
